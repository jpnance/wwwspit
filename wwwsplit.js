// todo
// * warmup mode
// * be able to save splits from unfinished runs

var data2 = [
	{
		id: 1,
		game: 'Super Mario 64',
		category: '16-Star',
		segments: [{"name":"Bob-Omb Battlefield (1)","best":{"split":104923,"duration":{"individual":98588,"run":104923}},"history":[98588,98835,98905,98946,98961,99069,99072,99094,99189,99218,99224,99317,99320,99337,99355,99421,99444,99488,99496,99513,99524,99538,99592,99614,99636,99670,99781,99793,99945,99987,100152,100183,100231,100233,100253,100261,100367,100440,100444,100464,100486,100586,100597,100597,100603,100727,100835,100896,100974,101026,101084,101149,101169,101317,101615,101667,101789,102134,102150,102671,102844,102948,102997,103073,103190,103696,104588,104658,104923,107060,107199,107239,107271,107295,107328,107356,107398,107418,107597,107685,107709,107769,107795,107828,108076,108213,108238,108246,108276,108276,108278,108346,108369,108402,108436,108441,108561,108589,108649,108707,108791,109007,109123,109247,109392,109455,109460,109497,109524,109590,109593,109624,109629,109964,110196,110264,110372,110514,110714,111239,111564,111684,112593,112902,113059,113675,114006,114156,114189,114198,114227,114324,114358,114458,114518,114545,114696,114708,114739,114785,114973,115006,115066,115094,115118,115168,115227,115229,115324,115440,115462,115491,115553,115629,115671,115790,115800,115852,115863,115863,115958,116164,116272,116331,116847,116908,117020,117030,117237,117454,118016,118929,118958,119017,120011,120144,120568,120680,120717,120779,120879,121006,121028,121132,121362,121370,121447,121749,121801,122033,122153,122206,122637,122933,123276,123574,123670,123671,123812,123828,123869,123927,124187,124211,124340,124397,124502,124617,124625,124679,124686,124823,124831,125131,125365,125494,125790,125906,126027,126035,126590,128849,128892,129171,129264,129287,129622,129698,129703,130693,131986,132048,132253,132469,135150,163504]},{"name":"Whomp's Fortress (6)","best":{"split":306968,"duration":{"individual":199101,"run":202045}},"history":[199101,199965,200119,200190,200303,200507,200539,200542,200857,200859,201052,201422,201595,201624,201627,201715,201787,201881,202045,202073,202136,202331,202730,202875,202963,203226,203607,203641,203675,203772,203872,204219,204446,204507,204570,204635,204770,204793,204827,204859,205021,205028,205146,205148,205152,205371,205437,205471,205485,205525,205530,205724,205854,205913,206075,206143,206265,206313,206321,206327,206338,206361,206723,206806,206815,207035,207069,207164,207166,207228,207257,207323,207359,207389,207410,207479,207513,207574,207631,207643,207711,207770,207869,207899,208020,208140,208310,208317,208334,208414,208475,208475,208501,208636,208662,208696,208953,208986,209076,209125,209180,209180,209788,209946,210047,210050,210060,210075,210109,210244,210331,210360,210587,210715,210811,210812,210940,211035,211044,211164,211260,211261,211385,211401,211418,211645,211675,211800,211837,211898,212314,212345,212378,212407,212465,212617,212670,212820,213020,213309,213539,213587,213627,213670,213916,213986,214100,214654,214683,214714,215005,215193,215321,215353,215414,215837,215899,215992,216173,216285,216478,217303,217884,218074,218468,218519,218782,219069,219294,220282,220347,220823,221251,221569,221797,221809,221953,223069,223355,223416,224184,224856,225266,225277,225368,225626,225654,225776,226042,227260,227287,227394,228599,229211,229664,229754,229846,232081,232089,233398,234810,236632,237280,237691,241834,243803,244280,245106,245371,245763,246522,249774,254393,255769,257214,258504,265655,266485,275192,282519]},{"name":"Cool Cool Mountain (8)","best":{"split":391383,"duration":{"individual":82336,"run":84415}},"history":[82336,82532,82654,83016,83045,83105,83167,83202,83420,83638,83643,83649,83708,83773,83838,83872,84029,84070,84094,84154,84285,84414,84415,84507,84542,84572,84670,84703,84704,84709,84782,84797,84797,84828,84894,84926,84926,84933,84961,84991,85020,85087,85119,85212,85243,85277,85318,85322,85342,85370,85373,85406,85406,85542,85566,85693,85694,85696,85728,85729,85793,85837,85887,85910,85920,85982,86044,86046,86140,86142,86200,86205,86237,86299,86336,86365,86395,86429,86459,86504,86623,86672,86747,86751,86753,86811,86843,86844,86846,86879,86940,87003,87067,87101,87131,87221,87266,87332,87332,87392,87420,87421,87561,87613,87772,87807,87868,88048,88252,88254,88260,88352,88382,88411,88411,88448,88542,88563,88603,88607,88610,88637,88697,88702,88740,88799,88960,89053,89116,89118,89185,89220,89245,89267,89335,89373,89562,89598,89781,89822,89886,89934,89983,90110,90143,90170,90206,90267,90364,90525,90565,90589,90589,90750,91105,91106,91266,91711,92030,92163,92191,92213,92382,92408,92415,92538,93052,93274,93313,93884,94081,94207,94812,94878,94878,94903,94974,95072,95294,95580,95581,96093,96287,96381,96606,96800,98203,99355,99683,100093,100452,100924,101102,101472,102175,102333,102494,104670,106173,106909,107485,107806,108231,108349,110014,110143,110343,110527,110781,112059,114140,116125,117211,119308,124479,124958,125761,154612,156192]},{"name":"Bowser in the Dark World (9)","best":{"split":517714,"duration":{"individual":123193,"run":126331}},"history":[123193,125565,125917,125979,126101,126203,126206,126302,126331,126424,126491,126595,126620,126688,126784,127010,127085,127100,127229,127268,127396,127475,127647,127697,127709,127868,127896,128155,128157,128185,128445,129021,129212,129344,129369,129374,129505,129726,130232,130364,130429,130457,130463,130529,130617,130620,130684,130972,131102,131164,131397,131837,132182,133180,133267,133372,134363,134495,134682,135098,135321,135479,135822,136352,136668,137690,138076,138237,138301,139868,141133,141406,141498,141918,142337,143902,145119,145373,152732,153249,153850,157148,162482,162555,164092,167362,171292,188027,188694,194557,206683,213959,220310,232244,237913,238681,238683,284952,354615]},{"name":"Shifting Sand Land (11)","best":{"split":610770,"duration":{"individual":86881,"run":93056}},"history":[86881,87487,87677,87765,87837,87930,87936,87996,88022,88039,88061,88062,88062,88189,88259,88318,88382,88450,88479,88538,88542,88638,88671,88672,88760,88892,88893,88895,88897,88925,88927,88937,89054,89078,89083,89148,89150,89183,89185,89213,89270,89276,89277,89305,89314,89337,89341,89343,89411,89504,89535,89536,89541,89589,89595,89598,89664,89715,89748,89753,89759,89833,89856,89924,90045,90078,90141,90142,90174,90204,90204,90205,90234,90241,90268,90301,90301,90303,90379,90396,90397,90421,90497,90504,90623,90654,90722,90726,90750,90782,90803,90813,90850,91134,91194,91228,91278,91295,91295,91341,91390,91390,91453,91454,91455,91488,91489,91510,91551,91704,91708,91709,91947,91959,91970,92073,92122,92156,92158,92167,92189,92223,92288,92350,92482,92508,92512,92574,92579,92638,92639,92690,92695,92795,92959,93021,93056,93057,93215,93274,93415,93474,93530,93567,93569,93661,94049,94112,94283,94304,94463,94682,94973,94974,95166,95200,95323,95416,95480,95602,95831,96092,96318,96328,96570,96830,97218,97838,97925,98494,99101,99225,99264,99804,100156,100281,100493,100540,100862,101175,101413,102301,102493,102528,102735,103131,103262,103385,104061,104190,104255,104477,105061,105628,105821,107046,108189,108250,108260,108345,108413,108927,109533,109790,109982,110267,110302,111800,112127,113694,114907,116221,116230,116783,118651,119031,119078,119123,119804,120285,121370,122396,124730,127546,128445,129085,137789,139310,142783,147486,169944]},{"name":"Lethal Lava Land (12)","best":{"split":644173,"duration":{"individual":32862,"run":33403}},"history":[32862,33058,33088,33183,33184,33214,33229,33238,33247,33247,33311,33337,33338,33373,33374,33403,33407,33411,33437,33466,33469,33472,33475,33497,33503,33517,33526,33566,33582,33597,33598,33629,33629,33630,33630,33631,33632,33658,33661,33662,33693,33695,33695,33727,33729,33757,33759,33790,33794,33828,33852,33853,33876,33885,33887,33887,33888,33888,33917,33919,33936,33952,33953,33955,33981,33981,33981,34013,34014,34015,34047,34047,34049,34079,34080,34090,34109,34110,34114,34140,34150,34169,34172,34176,34176,34179,34192,34208,34211,34239,34241,34265,34271,34271,34299,34303,34304,34323,34330,34333,34335,34335,34335,34335,34347,34366,34369,34398,34399,34399,34403,34432,34451,34460,34460,34463,34464,34490,34494,34494,34496,34529,34529,34529,34556,34559,34559,34559,34560,34592,34621,34626,34640,34654,34656,34673,34684,34687,34688,34690,34690,34714,34717,34757,34782,34783,34784,34787,34815,34818,34819,34843,34847,34850,34910,34940,34944,34975,34976,35005,35038,35041,35071,35073,35074,35095,35105,35167,35167,35229,35296,35300,35327,35365,35388,35390,35488,35549,35552,35648,35743,35777,35780,35810,35816,35830,35838,35870,35902,35903,35935,35935,35972,36000,36123,36125,36158,36190,36222,36252,36253,36257,36285,36292,36382,36443,36444,36448,36510,36510,36541,36541,36542,36566,36702,36733,36925,37024,37147,37218,37270,37309,37344,37824,38300,38728,39487,40419,40863,41165,56513]},{"name":"Hazy Maze Cave (15)","best":{"split":731396,"duration":{"individual":77471,"run":87223}},"history":[77471,77758,78430,79036,79066,79103,79147,79165,79231,79231,79357,79615,79869,79931,79947,80032,80062,80128,80161,80350,80443,80446,80460,80478,80603,80640,80765,80799,80865,80917,80922,81022,81023,81087,81087,81116,81247,81275,81376,81378,81438,81633,81664,81884,81985,82016,82201,82334,82367,82430,82524,82560,82591,82697,82719,82913,83103,83137,83222,83361,83483,83605,84066,84127,84191,84348,84992,85179,85246,85794,85806,85823,86271,86562,86621,86845,87223,87612,87903,88100,88926,89435,89503,90170,92285,92541,95998,99770,100123,101284,103807,103902,105439,106365,107548,116382,117919,121720]},{"name":"Dire Dire Docks (16)","best":{"split":824331,"duration":{"individual":91165,"run":92935}},"history":[91165,91805,91806,92001,92702,92766,92935,93511,93585,93754,93758,94078,94087,94365,94398,94407,94619,94900,95038,95047,95454,95486,95520,95645,95679,95712,95741,95773,95774,95839,95966,95998,96064,96221,96250,96414,96448,96477,96637,96702,97055,97405,97472,97600,97730,97744,97753,97947,97947,98079,98085,98173,98233,98686,98743,98788,98849,98912,98943,99036,99197,99230,99329,99810,99860,99902,100254,100354,100414,100541,100574,100636,100639,100731,100734,100766,100796,100928,100991,101174,101212,101308,101383,101405,101471,101566,101755,101887,101968,102131,102207,102310,102414,102433,102558,102588,103228,103425,104222,104225,104255,104284,104289,104447,104617,104635,104734,104932,105279,105369,105403,105513,105694,105853,105950,106044,106268,106329,106782,106909,107050,107538,107740,107810,107970,108095,108130,108159,108183,108252,108350,108396,108541,108670,108734,109052,109119,109147,109182,110045,110077,110153,110172,110267,110366,110433,110591,110715,110811,111453,111518,111550,111579,111613,111617,111630,112345,112539,112640,112956,113085,113119,113180,113215,113279,113309,113372,113562,113623,114048,114172,114215,114369,114498,114645,115228,115446,115742,115840,116733,116774,116892,117086,117343,117359,117374,117440,117533,117694,117726,118173,118238,118781,119165,119710,121332,121460,122397,122621,122751,123004,124061,124127,124222,124258,124292,124733,125278,125661,125851,127087,127218,127516,127805,128387,129210,129631,131670,133122,134499,134884,135611,135737,136450,137087,139004,143070,147901,149342,160541,161501,162654,168123]},{"name":"Bowser in the Fire Sea","best":{"split":920968,"duration":{"individual":95038,"run":96637}},"history":[95038,95327,95357,95452,95464,95485,95515,95586,95645,95653,95735,95736,95774,95775,95900,95963,95964,95964,96039,96093,96093,96128,96190,96213,96270,96284,96286,96287,96288,96318,96325,96381,96416,96421,96443,96447,96449,96455,96458,96479,96507,96543,96562,96573,96604,96637,96702,96727,96760,96764,96766,96796,96799,96831,96862,96886,96889,96890,96894,96896,96925,96927,96955,96988,97021,97060,97086,97118,97147,97217,97248,97276,97310,97338,97403,97438,97442,97504,97563,97567,97594,97596,97727,97730,97759,97762,97855,97932,97947,97950,97957,98014,98044,98168,98203,98204,98299,98356,98398,98489,98492,98498,98506,98654,98667,98684,98686,98717,98813,98909,99039,99100,99101,99136,99164,99334,99375,99378,99453,99455,99517,99614,99614,100092,100157,100188,100410,100669,100862,100993,101150,101212,101728,101918,102303,102750,102942,103386,103866,104055,104574,104702,105560,105624,106014,106140,106493,106525,107197,108833,108923,109300,109589,109693,109694,110367,110561,110879,110911,111181,111326,111356,111447,111484,111551,111613,111645,111776,111999,112030,112252,112284,112500,112996,113056,113597,113638,114331,114391,114909,114912,115709,115873,115935,115965,116734,116795,117592,117596,117727,118071,118310,119167,119261,119423,120254,121468,123279,124122,125066,125605,126783,129046,131071,131324,132316,132864,133023,134787,134973,135230,136725,137468,137788,138045,138427,142431,142816,143644,146588,147609,152924,154461,155804,157263,157814,159135,169854,179450,187868,198872,212925,213178,237942,246782]},{"name":"Bowser in the Sky","best":{"split":1113672,"duration":{"individual":171183,"run":192704}},"history":[171183,173602,176985,177248,177754,177884,178206,178299,178302,178334,179069,179868,179972,180378,180607,181873,182364,182653,183707,183942,184506,185150,185372,185752,185754,185975,186616,187100,187579,187805,188052,188957,188983,189627,191749,191932,192071,192704,194421,195387,195836,196804,198072,198206,198234,198299,199036,199242,199806,201184,203486,204507,204537,204795,204829,204859,204923,205371,205533,205596,205853,205881,205981,206938,207962,208036,208632,208918,208953,209406,209459,209980,211163,211353,211993,212603,212815,212857,212861,213818,214681,216235,217266,217763,218810,218894,219130,219160,219707,219836,220281,220383,220412,220794,220983,221696,222363,222812,223067,223638,224285,224604,225212,225274,225945,226399,226431,227552,228059,229337,229980,230716,230805,231323,232326,232410,233143,233372,233977,234074,235066,236492,236950,237015,237692,239408,239483,239958,240602,240794,241787,242302,243130,243290,243636,244051,244828,244962,245145,245626,250134,250426,250427,250493,251971,252095,252491,252606,252698,255676,256333,256508,256509,257690,257700,257883,258713,258830,259673,259761,260254,261721,262000,264760,266394,266810,267103,267542,270124,270926,271022,271605,271780,273176,274362,274930,277143,279293,280793,281084,281144,281177,281373,287195,288273,289243,289371,290110,292250,292925,296824,298196,300203,300312,300987,302773,303102,303409,308855,309139,310073,311640,312087,315127,317695,317882,319513,322880,325541,325679,328013,329890,330170,331548,341376,341914,342076,342616,343737,346730,347480,349145,350807,359904,377941,389589,389748,393453,396152,396597,418358,463416,479639,488530,548787,616566]}]
	},
	{
		id: 2,
		game: 'Super Mario World 2: Yoshi\'s Island',
		category: 'Any% Warpless',
		/*
		segments: [
			{ name: "1-1: Make Eggs, Throw Eggs" },
			{ name: "1-2: Watch Out Below!" },
			{ name: "1-3: The Cave of Chomp Rock" },
			{ name: "1-4: Burt the Bashful's Fort" },
			{ name: "1-5: Hop! Hop! Donut Lifts" },
			{ name: "1-6: Shy-Guys on Stilts" },
			{ name: "1-7: Touch Fuzzy, Get Dizzy" },
			{ name: "1-8: Salvo the Slime's Castle" },
			{ name: "2-1: Visit Koopa and Para-Koopa" },
			{ name: "2-2: The Baseball Boys" },
			{ name: "2-3: What's Gusty Taste Like?" },
			{ name: "2-4: Bigger Boo's Fort" },
			{ name: "2-5: Watch Out for Lakitu!" },
			{ name: "2-6: The Cave of the Mystery Maze" },
			{ name: "2-7: Lakitu's Wall" },
			{ name: "2-8: The Potted Ghost's Castle" },
			{ name: "3-1: Welcome to Monkey World!" },
			{ name: "3-2: Jungle Rhythm..." },
			{ name: "3-3: Nep-Enut's Domain" },
			{ name: "3-4: Prince Froggy's Fort" },
			{ name: "3-5: Jammin' through the Trees" },
			{ name: "3-6: The Cave of Harry Hedgehog" },
			{ name: "3-7: Monkeys' Favorite Lake" },
			{ name: "3-8: Naval Piranha's Castle" },
			{ name: "4-1: GO! GO! MARIO!!" },
			{ name: "4-2: The Cave of the Lakitus" },
			{ name: "4-3: Don't Look Back!" },
			{ name: "4-4: Marching Milde's Fort" },
			{ name: "4-5: Chomp Rock Zone" },
			{ name: "4-6: Lake Shore Paradise" },
			{ name: "4-7: Ride like the Wind" },
			{ name: "4-8: Hookbill the Koopa's Castle" },
			{ name: "5-1: BLIZZARD!!!" },
			{ name: "5-2: Ride the Sky Lifts" },
			{ name: "5-3: Danger - Icy Conditions Ahead" },
			{ name: "5-4: Sluggy the Unshaven's Fort" },
			{ name: "5-5: Goonie Rides!" },
			{ name: "5-6: Welcome to Cloud World" },
			{ name: "5-7: Shifting Platforms Ahead" },
			{ name: "5-8: Raphael the Raven's Castle" },
			{ name: "6-1: Scary Skeleton Goonies!" },
			{ name: "6-2: The Cave of the Bandits" },
			{ name: "6-3: Beware the Spinning Logs" },
			{ name: "6-4: Tap-Tap the Red Nose's Fort" },
			{ name: "6-5: The Very Loooooong Cave" },
			{ name: "6-6: The Deep, Underground Maze" },
			{ name: "6-7: KEEP MOVING!!!!" },
			{ name: "6-8: King Bowser's Castle" }
		]
		*/
		segments: [{"name":"1-1: Make Eggs, Throw Eggs","best":{"split":104168,"duration":{"individual":97598,"run":104168}},"history":[97598,101527,103174,104168,110329,125018,125962,140043]},{"name":"1-2: Watch Out Below!","best":{"split":181189,"duration":{"individual":77021,"run":77021}},"history":[77021,78007,80350,82430,83164,88898,94781,103741]},{"name":"1-3: The Cave of Chomp Rock","best":{"split":263235,"duration":{"individual":78144,"run":82046}},"history":[78144,79850,80282,80287,82046,83099,85022,155678]},{"name":"1-4: Burt the Bashful's Fort","best":{"split":417316,"duration":{"individual":142845,"run":154080}},"history":[142845,146132,146498,148349,150011,154080,213211,259482]},{"name":"1-5: Hop! Hop! Donut Lifts","best":{"split":593953,"duration":{"individual":176634,"run":176636}},"history":[176634,176636,176795,176828,176955,177146,177495,179422]},{"name":"1-6: Shy-Guys on Stilts","best":{"split":681882,"duration":{"individual":87929,"run":87929}},"history":[87929,91294,91869,94299,95135,95581,98276,110174]},{"name":"1-7: Touch Fuzzy, Get Dizzy","best":{"split":747032,"duration":{"individual":64930,"run":65150}},"history":[64930,65150,67416,67515,71296,77376,78461,99874]},{"name":"1-8: Salvo the Slime's Castle","best":{"split":901460,"duration":{"individual":143932,"run":154428}},"history":[143932,147650,152861,154428,162331,176348,183131,188032]},{"name":"2-1: Visit Koopa and Para-Koopa","best":{"split":1046834,"duration":{"individual":143698,"run":145374}},"history":[143698,145374,146045,148226,149277,153599,225564,243750]},{"name":"2-2: The Baseball Boys","best":{"split":1204711,"duration":{"individual":151567,"run":157877}},"history":[151567,154848,157877,158392,159871,168312,189751,197853]},{"name":"2-3: What's Gusty Taste Like?","best":{"split":1309609,"duration":{"individual":99166,"run":104898}},"history":[99166,101368,104898,106622,106845,111849,121973,127544]},{"name":"2-4: Bigger Boo's Fort","best":{"split":1442822,"duration":{"individual":124127,"run":133213}},"history":[124127,129056,133213,136765,138737,139963,231738,323674]},{"name":"2-5: Watch Out for Lakitu!","best":{"split":1534404,"duration":{"individual":78587,"run":91582}},"history":[78587,83483,83936,86015,87782,89797,91582,126203]},{"name":"2-6: The Cave of the Mystery Maze","best":{"split":1624705,"duration":{"individual":89947,"run":90301}},"history":[89947,90301,90620,90863,91390,93332,96543,99767]},{"name":"2-7: Lakitu's Wall","best":{"split":1738559,"duration":{"individual":108682,"run":113854}},"history":[108682,109789,113854,114577,116156,119013,120191,134429]},{"name":"2-8: The Potted Ghost's Castle","best":{"split":1992922,"duration":{"individual":237210,"run":254363}},"history":[237210,246330,247386,247856,254363,263457,273009,288312]},{"name":"3-1: Welcome to Monkey World!","best":{"split":2107542,"duration":{"individual":114620,"run":114620}},"history":[114620,116348,119900,121419,122852,124062,126404]},{"name":"3-2: Jungle Rhythm...","best":{"split":2188980,"duration":{"individual":81438,"run":81438}},"history":[81438,85279,90418,101309,104057,129996,137655]},{"name":"3-3: Nep-Enut's Domain","best":{"split":2387089,"duration":{"individual":191196,"run":198109}},"history":[191196,194521,197882,198109,198365,205432,216387]},{"name":"3-4: Prince Froggy's Fort","best":{"split":2582058,"duration":{"individual":194969,"run":194969}},"history":[194969,195750,195835,196311,197379,203351,279417]},{"name":"3-5: Jammin' through the Trees","best":{"split":2673355,"duration":{"individual":88608,"run":91297}},"history":[88608,91297,92324,92483,92925,96542,113631,151168]},{"name":"3-6: The Cave of Harry Hedgehog","best":{"split":2761958,"duration":{"individual":77253,"run":88603}},"history":[77253,79072,80087,80119,81715,82104,83004,88603]},{"name":"3-7: Monkeys' Favorite Lake","best":{"split":2864675,"duration":{"individual":102717,"run":102717}},"history":[102717,106748,107907,110972,114779,115197,119590,120182]},{"name":"3-8: Naval Piranha's Castle","best":{"split":3008069,"duration":{"individual":138934,"run":143394}},"history":[138934,143134,143394,143424,147934,148401,155813,156375]},{"name":"4-1: GO! GO! MARIO!!","best":{"split":3170333,"duration":{"individual":142941,"run":162264}},"history":[142941,143042,145466,147388,150844,162264,165075,189982]},{"name":"4-2: The Cave of the Lakitus","best":{"split":3252890,"duration":{"individual":82079,"run":82557}},"history":[82079,82557,83665,83681,83857,85407,94015,94075]},{"name":"4-3: Don't Look Back!","best":{"split":3348055,"duration":{"individual":91998,"run":95165}},"history":[91998,95165,97185,98352,120798,122460,179877]},{"name":"4-4: Marching Milde's Fort","best":{"split":3704018,"duration":{"individual":351259,"run":355963}},"history":[351259,355963,363924,380087,417812,451315,524244]},{"name":"4-5: Chomp Rock Zone","best":{"split":3792360,"duration":{"individual":85756,"run":88342}},"history":[85756,87068,88342,89852,90079,92087,101247,122294]},{"name":"4-6: Lake Shore Paradise","best":{"split":3918058,"duration":{"individual":115326,"run":125698}},"history":[115326,123566,125698,130491,131041,145853,148649,153246]},{"name":"4-7: Ride like the Wind","best":{"split":4015495,"duration":{"individual":95801,"run":97437}},"history":[95801,97437,104864,108224,110853,115343,115826,117373]},{"name":"4-8: Hookbill the Koopa's Castle","best":{"split":4231682,"duration":{"individual":205435,"run":216187}},"history":[205435,212569,216187,222039,223586,228088,257619,290230]},{"name":"5-1: BLIZZARD!!!","best":{"split":4381632,"duration":{"individual":144834,"run":149950}},"history":[144834,149950,150045,150466,155059,166013,184541,270425]},{"name":"5-2: Ride the Sky Lifts","best":{"split":4522335,"duration":{"individual":113920,"run":140703}},"history":[113920,122331,122426,126114,140703,143421,164769,231129]},{"name":"5-3: Danger - Icy Conditions Ahead","best":{"split":4719158,"duration":{"individual":196823,"run":196823}},"history":[196823,204668,217622,258461,275184,278455,428849,473010]},{"name":"5-4: Sluggy the Unshaven's Fort","best":{"split":5051536,"duration":{"individual":326066,"run":332378}},"history":[326066,328378,332378,332571,334326,340216,345819,347766]},{"name":"5-5: Goonie Rides!","best":{"split":5173931,"duration":{"individual":120958,"run":122395}},"history":[120958,122395,126717,138536,145757,151576,190422,232567]},{"name":"5-6: Welcome to Cloud World","best":{"split":5453254,"duration":{"individual":272347,"run":279323}},"history":[272347,272859,273020,279323,282233,284218,284401,349912]},{"name":"5-7: Shifting Platforms Ahead","best":{"split":5623264,"duration":{"individual":132390,"run":170010}},"history":[132390,142817,163515,170010,198744,212122,214521,225304]},{"name":"5-8: Raphael the Raven's Castle","best":{"split":5949816,"duration":{"individual":211259,"run":326552}},"history":[211259,219388,233147,236760,240411,252473,256671,326552]},{"name":"6-1: Scary Skeleton Goonies!","best":{"split":6158613,"duration":{"individual":169145,"run":208797}},"history":[169145,171004,174751,178097,186160,208797,212540,231994]},{"name":"6-2: The Cave of the Bandits","best":{"split":6275509,"duration":{"individual":116896,"run":116896}},"history":[116896,132100,135194,138547,143736,146623,147965,182407]},{"name":"6-3: Beware the Spinning Logs","best":{"split":6417132,"duration":{"individual":83411,"run":141623}},"history":[83411,88734,89370,90602,91514,107389,116414,141623]},{"name":"6-4: Tap-Tap the Red Nose's Fort","best":{"split":6647945,"duration":{"individual":199706,"run":230812}},"history":[199706,208539,230812,257626,269719,280228,317336,402963]},{"name":"6-5: The Very Loooooong Cave","best":{"split":6943589,"duration":{"individual":264271,"run":295644}},"history":[264271,287544,289945,295644,301211,325089,336632,388726]},{"name":"6-6: The Deep, Underground Maze","best":{"split":7048733,"duration":{"individual":105144,"run":105144}},"history":[105144,110653,129660,136060,158043,158043,165622,185690]},{"name":"6-7: KEEP MOVING!!!!","best":{"split":7256536,"duration":{"individual":207803,"run":207803}},"history":[207803,212827,225721,251388,274044,277458,295332,307415]},{"name":"6-8: King Bowser's Castle","best":{"split":7636339,"duration":{"individual":343893,"run":379803}},"history":[343893,345272,348378,362744,369309,379803,391061,392875]}]
	},
	{
		id: 3,
		game: 'Super Mario 64',
		category: '70-Star',
		/*
		segments: [
			{ name: 'Bob-Omb Battlefield I (1)' },
			{ name: 'The Princess\'s Secret Slide I (2)' },
			{ name: 'Whomp\'s Fortress (9)' },
			{ name: 'The Princess\'s Secret Slide II (10)' },
			{ name: 'Tower of the Wing Cap (11)' },
			{ name: 'Bowser in the Dark World (12)' },
			{ name: 'Bob-Omb Battlefield II (13)' },
			{ name: 'Cool Cool Mountain (18)' },
			{ name: 'Big Boo\'s Haunt (20)' },
			{ name: 'Mips I (21)' },
			{ name: 'Lethal Lava Land (27)' },
			{ name: 'Shifting Sand Land (30)' },
			{ name: 'Hazy Maze Cave (36)' },
			{ name: 'Dire Dire Docks (39)' },
			{ name: 'Bowser in the Fire Sea (40)' },
			{ name: 'Wet Dry World (45)' },
			{ name: 'Tiny Huge Island (48)' },
			{ name: 'Tall Tall Mountain (54)' },
			{ name: 'Snowman\'s Land (59)' },
			{ name: 'Rainbow Ride (64)' },
			{ name: 'Tick Tock Clock (70)' },
			{ name: 'Bowser in the Sky' }
		]
		*/
		segments: [{"name":"Bob-Omb Battlefield I (1)","best":{"split":99590,"duration":{"individual":99590,"run":99590}},"history":[99590,99778]},{"name":"The Princess's Secret Slide I (2)","best":{"split":163838,"duration":{"individual":64248,"run":64248}},"history":[64248,64560]},{"name":"Whomp's Fortress (9)","best":{"split":475991,"duration":{"individual":312153,"run":312153}},"history":[312153,374451]},{"name":"The Princess's Secret Slide II (10)","best":{"split":532726,"duration":{"individual":56735,"run":56735}},"history":[56735,62138]},{"name":"Tower of the Wing Cap (11)","best":{"split":631826,"duration":{"individual":99100,"run":99100}},"history":[99100,154109]},{"name":"Bowser in the Dark World (12)","best":{"split":null,"duration":{"individual":115829,"run":null}},"history":[115829]},{"name":"Bob-Omb Battlefield II (13)","best":{"split":null,"duration":{"individual":186789,"run":null}},"history":[186789]},{"name":"Cool Cool Mountain (18)","best":{"split":1237956,"duration":{"individual":553616,"run":null}},"history":[553616]},{"name":"Big Boo's Haunt (20)","best":{"split":1404704,"duration":{"individual":166748,"run":166748}},"history":[166748,227866]},{"name":"Mips I (21)","best":{"split":1449791,"duration":{"individual":45087,"run":45087}},"history":[45087,60349]},{"name":"Lethal Lava Land (27)","best":{"split":1851349,"duration":{"individual":373301,"run":401558}},"history":[373301,401558]},{"name":"Shifting Sand Land (30)","best":{"split":1986289,"duration":{"individual":134940,"run":134940}},"history":[134940,188892]},{"name":"Hazy Maze Cave (36)","best":{"split":2232482,"duration":{"individual":246193,"run":246193}},"history":[246193,322071]},{"name":"Dire Dire Docks (39)","best":{"split":2452582,"duration":{"individual":220100,"run":220100}},"history":[220100,229626]},{"name":"Bowser in the Fire Sea (40)","best":{"split":2625859,"duration":{"individual":173277,"run":173277}},"history":[173277,310968]},{"name":"Wet Dry World (45)","best":{"split":2956028,"duration":{"individual":330169,"run":330169}},"history":[330169,582961]},{"name":"Tiny Huge Island (48)","best":{"split":3165337,"duration":{"individual":209309,"run":209309}},"history":[209309,394395]},{"name":"Tall Tall Mountain (54)","best":{"split":3524303,"duration":{"individual":358966,"run":358966}},"history":[358966,927331]},{"name":"Snowman's Land (59)","best":{"split":3746183,"duration":{"individual":221880,"run":221880}},"history":[221880,542961]},{"name":"Rainbow Ride (64)","best":{"split":4183868,"duration":{"individual":437685,"run":437685}},"history":[437685,870762]},{"name":"Tick Tock Clock (70)","best":{"split":4866926,"duration":{"individual":683058,"run":683058}},"history":[683058,1003014]},{"name":"Bowser in the Sky","best":{"split":5050663,"duration":{"individual":136412,"run":183737}},"history":[136412,183737]}]
	},
	{
		id: 4,
		game: 'wwwsplit',
		category: 'Be Accurate',
		segments: [
			{ name: 'Five Seconds' },
			{ name: 'Seven Seconds' },
			{ name: 'Ten Seconds' },
			{ name: 'Twelve Seconds' },
			{ name: 'Seventeen Seconds' },
			{ name: 'Twenty Seconds' },
			{ name: 'Twenty-One Seconds' },
			{ name: 'Twenty-Three Seconds' },
			{ name: 'Twenty-Nine Seconds' },
			{ name: 'Thirty Seconds' }
		]
	}
];

var run = {
	activateSegment: function(segmentId) {
		this.data.segments[segmentId].active = true;

		delete this.data.segments[segmentId].split;
		delete this.data.segments[segmentId].duration;
		delete this.data.segments[segmentId].ignored;

		if (!this.data.segments[segmentId].start) {
			this.data.segments[segmentId].start = this.timer.runningTime();
		}
	},
	activeSegmentId: function() {
		for (segmentId in this.data.segments) {
			if (this.data.segments[segmentId].active) {
				return parseInt(segmentId);
			}
		}

		return null;
	},
	advanceActiveSegment: function() {
		var activeSegmentId = this.activeSegmentId();

		if (activeSegmentId != null) {
			var nextSegmentId = activeSegmentId + 1;

			this.splitSegment(activeSegmentId);

			if (this.data.segments.length > nextSegmentId) {
				this.activateSegment(nextSegmentId);
			}
			else {
				this.stop();
			}

		}
		else {
			this.activateSegment(0);
		}
	},
	backfill: function(splits) {
		for (splitId in splits) {
			var time = splits[splitId];

			var minutes = time[0];
			var seconds = time[1];
			var centiseconds = time[2];

			if (splitId == 0) {
				this.data.segments[splitId].start = 0;
			}
			else {
				this.data.segments[splitId].start = this.data.segments[splitId - 1].split;
			}

			this.data.segments[splitId].split = this.timer.unformatMilliseconds(minutes, seconds, centiseconds);
			this.data.segments[splitId].duration = this.data.segments[splitId].split - this.data.segments[splitId].start;
		}
	},
	bestTimes: function() {
		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];
			console.log(segment.name + ': ' + this.timer.formatMilliseconds(segment.best.duration.individual));
		}
	},
	calculatePotentialBestRun: function() {
		var sumOfBestSegmentDurations = 0;

		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];

			if (segment.best && segment.best.duration.individual) {
				sumOfBestSegmentDurations += segment.best.duration.individual;
			}
			else {
				return 0;
			}
		}

		return sumOfBestSegmentDurations;
	},
	calculatePotentialBestRunRemaining: function() {
		var sumOfCurrentSegmentDurations = 0;
		var sumOfBestSegmentDurations = 0;

		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];

			if (segment.duration) {
				sumOfCurrentSegmentDurations += segment.duration;
			}
			else if (segment.best && segment.best.duration.individual) {
				sumOfBestSegmentDurations += segment.best.duration.individual;
			}
			else {
				return 0;
			}
		}

		return sumOfCurrentSegmentDurations + sumOfBestSegmentDurations;
	},
	calculatePredictedBestRunRemaining: function() {
		var sumOfCurrentSegmentDurations = 0;
		var sumOfPredictedSegmentDurations = 0;

		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];

			if (segment.duration) {
				sumOfCurrentSegmentDurations += segment.duration;
			}
			else if (segment.history) {
				var sumOfSegmentRecentHistoryDurations = 0;

				for (historyId in segment.history) {
					sumOfSegmentRecentHistoryDurations += segment.history[historyId];
				}

				sumOfPredictedSegmentDurations += Math.round(sumOfSegmentRecentHistoryDurations / segment.history.length);
			}
		}

		return sumOfCurrentSegmentDurations + sumOfPredictedSegmentDurations;
	},
	calculateMedianRunRemaining: function() {
		var sumOfCurrentSegmentDurations = 0;
		var sumOfPredictedSegmentDurations = 0;

		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];

			if (segment.duration) {
				sumOfCurrentSegmentDurations += segment.duration;
			}
			else if (segment.history && segment.history.length > 0) {
				var median = 0;
				var history = segment.history.sort(function(a, b) { return a - b; });
				var length = history.length;

				if (length % 2 == 0) {
					var medianLow = history[(history.length - 2) / 2];
					var medianHigh = history[history.length / 2];

					median = Math.round((medianLow + medianHigh) / 2);
				}
				else {
					median = history[(length - 1) / 2];
				}

				sumOfPredictedSegmentDurations += median;
			}
			else {
				return 0;
			}
		}

		return sumOfCurrentSegmentDurations + sumOfPredictedSegmentDurations;
	},
	config: {
		scrollAfter: 7 // specifies the number of splits after which we should start automatically scrolling down the list
	},
	deactivateSegment: function(segmentId) {
		this.data.segments[segmentId].active = false;
		delete this.data.segments[segmentId].start;
		delete this.data.segments[segmentId].duration;
		delete this.data.segments[segmentId].ignored;
	},
	finalizeRunTable: function() {
		var elapsedTime = 0;

		if (!this.running) {
			$('div#run div.segment').removeClass('active');
		}

		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];
			var $segment = $('div#run div#segment' + segmentId);
			var $slice = $('div#run div#slice' + segmentId);
			$segment.find('div.difference').html('').removeClass('ahead behind gaining losing new-best');
			$slice.removeClass('ahead behind gaining losing new-best');

			var previousSegment = (segmentId > 0) ? this.data.segments[segmentId - 1] : null;

			if (segment.split && segment.best && segment.best.split) {
				var difference = this.timer.formatMilliseconds(segment.split - segment.best.split, true);

				$segment.find('div.difference').html(difference);

				if (difference[0] == '-') {
					$segment.find('div.difference').removeClass('behind').addClass('ahead');
					$slice.removeClass('behind').addClass('ahead');
				}
				else {
					$segment.find('div.difference').removeClass('ahead').addClass('behind');
					$slice.removeClass('ahead').addClass('behind');
				}

				if (previousSegment && previousSegment.best) {
					if (segment.split - segment.best.split > previousSegment.split - previousSegment.best.split) {
						$segment.find('div.difference').removeClass('gaining').addClass('losing');
						$slice.removeClass('gaining').addClass('losing');
					}
					else if (segment.split - segment.best.split < previousSegment.split - previousSegment.best.split) {
						$segment.find('div.difference').removeClass('losing').addClass('gaining');
						$slice.removeClass('losing').addClass('gaining');
					}
				}
			}

			if (segment.duration && segment.best && segment.best.duration.individual) {
				if (segment.duration < segment.best.duration.individual && (!segment.ignored || !segment.ignored.duration)) {
					$segment.find('div.difference').addClass('new-best');
					$slice.addClass('new-best');
				}
			}

			if (segment.duration) {
				$segment.find('div.time').html(this.timer.formatMilliseconds(segment.duration));
			}

			if (segment.split) {
				$segment.find('div.split').html(this.timer.formatMilliseconds(segment.split));

				if (segment.split > elapsedTime) {
					elapsedTime = segment.split;
				}
			}
			else {
				if (segment.best && segment.best.split) {
					$segment.find('div.split').html(this.timer.formatMilliseconds(segment.best.split));
				}
				else {
					$segment.find('div.split').text('-');
				}
			}

			if (!segment.active && segment.ignored && segment.ignored.split) {
				$segment.addClass('ignored');
				$segment.find('div.difference').text('-').removeClass('ahead behind gaining losing new-best');
				$segment.find('div.split').text('-');

				$slice.addClass('ignored');
				$slice.removeClass('ahead behind gaining losing new-best');
			}
			else {
				$segment.removeClass('ignored');
				$slice.removeClass('ignored');
			}

		}

		var potentialBestRunRemaining = this.calculatePotentialBestRunRemaining();
		var medianRunRemaining = this.calculateMedianRunRemaining();

		$('div#run div.timer div.clock').html(this.timer.formatMilliseconds(elapsedTime));
		$('div#run div.stats div.stat.possible div.time').html(potentialBestRunRemaining != 0 ? this.timer.formatMilliseconds(potentialBestRunRemaining) : '-');
		//$('div#run div.possible div.predicted').text(this.timer.formatMilliseconds(this.calculatePredictedBestRunRemaining()));
		$('div#run div.stats div.stat.predicted div.time').html(medianRunRemaining != 0 ? this.timer.formatMilliseconds(medianRunRemaining) : '-');

		var activeSegmentId = this.activeSegmentId();
		var totalSegments = this.data.segments.length;

		if (activeSegmentId > this.config.scrollAfter) {
			$('div#run div.segments').animate({ 'scrollTop': 24 * (activeSegmentId - this.config.scrollAfter) }, 200);
		}
	},
	gatherEdits: function() {
		var data = {};

		var id = $('input[name=id]').val();

		if (id) {
			id = parseInt(id);
		}

		var segmentsText = $('textarea[name=segments]').val();
		var segmentStrings = segmentsText.split("\n");
		var segments = [];

		for (i in segmentStrings) {
			segments[i] = {};
			segments[i].name = segmentStrings[i];
		}

		data.id = parseInt(id);
		data.game = $('input[name=game]').val();
		data.category = $('input[name=category]').val();
		data.segments = segments;

		return data;
	},
	generateEditRunMarkup: function(editData) {
		var id = null;
		var game = '';
		var category = '';
		var segments = [];

		if (editData != null) {
			id = editData.id;
			game = editData.game;
			category = editData.category;
			segments = editData.segments;
		}

		$('div#run').remove();

		var $run = $('<div id="run">');

		var $runHeader = $('<div class="header">');
		var $gameHeader = $('<div class="game"><input name="game" type="text" value="' + game + '" placeholder="Game" tabindex="1" /></div>');
		var $categoryHeader = $('<div class="category"><input name="category" type="text" value="' + category + '" placeholder="Category" tabindex="2" /></div>');

		if (id) {
			var $idHeader = $('<input name="id" type="hidden" value="' + id + '" />');
			$runHeader.append($idHeader);
		}

		$runHeader.append($gameHeader).append($categoryHeader);
		$run.append($runHeader);

		var $runSegments = $('<div class="segments">');
		var $segmentsTextarea = $('<textarea name="segments" tabindex="3" placeholder="Segments; each segment should be on a separate line in this box.">');

		var segmentsString = '';

		for (id in segments) {
			segmentsString += segments[id].name + "\n";
		}

		$segmentsTextarea.append(segmentsString.trim());
		$runSegments.append($segmentsTextarea);
		$run.append($runSegments);

		var $runActions = $('<div class="actions">');
		var $saveButton = $('<button id="save" tabindex="4">Save</button>');
		var $cancelSpan = $('<span> or <a id="cancel" href="#" tabindex="5">cancel</a></span>');

		$runActions.append($saveButton);
		$runActions.append($cancelSpan);
		$run.append($runActions);

		$('body').prepend($run);
	},
	generateRunTable: function() {
		$('div#run').remove();

		var $run = $('<div id="run">');

		var $runHeader = $('<div class="header">');
		var $gameHeader = $('<div class="game">' + this.data.game + '</div>');
		var $categoryHeader = $('<div class="category">' + this.data.category + '</div>');

		$runHeader.append($gameHeader).append($categoryHeader);
		$run.append($runHeader);

		var $runSegments = $('<div class="segments">');
		var $runGraph = $('<div class="graph">');

		var totalPixels = 0;
		var carryOverPixels = 0.0;

		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];
			var $segment = $('<div id="segment' + segmentId + '" class="segment">');

			$segment.append('<div class="name">' + segment.name + '</div>');
			$segment.append('<div class="difference"></div>');
			$segment.append('<div class="split">' + (segment.best && segment.best.split ? this.timer.formatMilliseconds(segment.best.split) : '-') + '</div>');
			//$segment.append('<div class="split">' + this.timer.formatMilliseconds(segment.best.duration.run - segment.best.duration.individual) + '</div>');

			$runSegments.append($segment);

			var $slice = $('<div id="slice' + segmentId + '" class="slice">');

			var sliceWidth = 295 / this.data.segments.length;

			if (segmentId == this.data.segments.length - 1 && (sliceWidth % 1) != 0) {
				sliceWidth = 295 - totalPixels;
			}
			else {
				carryOverPixels += sliceWidth - Math.floor(sliceWidth);
				sliceWidth = Math.floor(sliceWidth);

				if (carryOverPixels > 1) {
					sliceWidth++;
					carryOverPixels--;
				}

				totalPixels += sliceWidth;
			}

			$slice.css({ width: sliceWidth + 'px' });
			$runGraph.append($slice);
		}

		$run.append($runSegments);
		$run.append($runGraph);

		var $runTimer = $('<div class="timer">');
		var $timerTarget = $('<div class="target">');
		var $timerClock = $('<div class="clock">' + this.timer.formatMilliseconds(0) + '</div>');

		$runTimer.append($timerTarget);
		$runTimer.append($timerClock);
		$run.append($runTimer);

		var $runStats = $('<div class="stats">');

		var potentialBestRunRemaining = this.calculatePotentialBestRunRemaining();
		var medianRunRemaining = this.calculateMedianRunRemaining();

		if (this.calculatePotentialBestRun() > 0) {
			var $possiblePerfectTime = $('<div class="stat perfect"><div class="name">Perfect Run</div><div class="time">' + this.timer.formatMilliseconds(this.calculatePotentialBestRun()) + '</div></div>');
			var $possibleRemainingTime = $('<div class="stat possible"><div class="name">Still Possible</div><div class="time">' + (potentialBestRunRemaining != 0 ? this.timer.formatMilliseconds(potentialBestRunRemaining) : '-') + '</div></div>');
			//var $possiblePredictedTime = $('<div class="possible"><div class="">More Likely</div><div class="predicted">' + this.timer.formatMilliseconds(this.calculatePredictedBestRunRemaining()) + '</div></div>');
			var $possiblePredictedTime = $('<div class="stat predicted"><div class="name">More Likely</div><div class="time">' + (medianRunRemaining != 0 ? this.timer.formatMilliseconds(medianRunRemaining) : '-') + '</div></div>');

			$runStats.append($possiblePerfectTime);
			$runStats.append($possibleRemainingTime);
			$runStats.append($possiblePredictedTime);
		}
		else {
			var $possiblePerfectTime = $('<div class="stat perfect"><div class="name">Perfect Run</div><div class="time">-</div></div>');
			var $possibleRemainingTime = $('<div class="stat possible"><div class="name">Still Possible</div><div class="time">-</div></div>');
			//var $possiblePredictedTime = $('<div class="possible"><div class="">More Likely</div><div class="predicted">-</div></div>');
			var $possiblePredictedTime = $('<div class="stat predicted"><div class="name">More Likely</div><div class="time">-</div></div>');

			$runStats.append($possiblePerfectTime);
			$runStats.append($possibleRemainingTime);
			$runStats.append($possiblePredictedTime);
		}

		$run.append($runStats);

		$run.find('div.segment:even').addClass('odd');
		$run.find('div.segment:first').addClass('first');
		$run.find('div.segment:last').addClass('last').prev().addClass('next-to-last');
		$run.find('div.stat:first').addClass('first');
		$run.find('div.stat:last').addClass('last');

		$('body').prepend($run);
	},
	ignoreSegmentSplit: function(segmentId) {
		if (!this.data.segments[segmentId].ignored) {
			this.data.segments[segmentId].ignored = {};
		}

		this.data.segments[segmentId].ignored.split = true;
	},
	ignoreSegmentDuration: function(segmentId) {
		if (!this.data.segments[segmentId].ignored) {
			this.data.segments[segmentId].ignored = {};
		}

		this.data.segments[segmentId].ignored.duration = true;
	},
	load: function(id) {
		var allData = JSON.parse(localStorage.getItem('data'));

		for (i in allData) {
			if (allData[i].id == id) {
				this.data = allData[i];
				run.generateRunTable();
				break;
			}
		}
	},
	purge: function() {
		localStorage.data = null;
	},
	regressActiveSegment: function() {
		var activeSegmentId = this.activeSegmentId();

		if (activeSegmentId != null && activeSegmentId != 0) {
			var previousSegmentId = activeSegmentId - 1;

			this.deactivateSegment(activeSegmentId);
			this.activateSegment(previousSegmentId);
		}
	},
	replacer: function(key, value) {
		switch (key) {
			case 'game':
			case 'category':
				return value;

			case 'segments':
				var segments = [];

				for (segmentId in value) {
					var segment = value[segmentId];
					segments.push({
						name: segment.name,
						best: segment.best,
						history: segment.history
					});
				}

				return segments;
		}

		return value;
	},
	reset: function() {
		if (!this.saved) {
			//confirm('Reset without saving?');
		}

		this.generateRunTable();

		for (segmentId in this.data.segments) {
			delete this.data.segments[segmentId].active;
			delete this.data.segments[segmentId].split;
			delete this.data.segments[segmentId].start;
			delete this.data.segments[segmentId].duration;
			delete this.data.segments[segmentId].ignored;
		}

		this.finalizeRunTable();

		this.saved = true;
	},
	revert: function() {
		localStorage.setItem('data', JSON.stringify(data, this.replacer));
	},
	running: false,
	save: function() {
		if (this.saved) {
			return;
		}

		var totalRunDuration = this.data.segments[this.data.segments.length - 1].split;
		var totalBestRunDuration = null;

		if (totalRunDuration) {
			if (this.data.segments[this.data.segments.length - 1].best) {
				totalBestRunDuration = this.data.segments[this.data.segments.length - 1].best.split;
			}

			for (segmentId in this.data.segments) {
				var segment = this.data.segments[segmentId];
				var ignoreDuration = segment.ignored && segment.ignored.duration;
				var ignoreSplit = segment.ignored && segment.ignored.split;

				if (!segment.best) {
					this.data.segments[segmentId].best = { split: null, duration: {} };
				}

				if (!segment.best.duration.individual || segment.duration < segment.best.duration.individual) {
					if (!ignoreDuration) {
						this.data.segments[segmentId].best.duration.individual = segment.duration;
					}
				}

				if (!totalBestRunDuration || totalRunDuration < totalBestRunDuration) {
					if (!ignoreSplit) {
						this.data.segments[segmentId].best.split = this.data.segments[segmentId].split;
					}
					else {
						this.data.segments[segmentId].best.split = null;
					}

					if (!ignoreDuration) {
						this.data.segments[segmentId].best.duration.run = this.data.segments[segmentId].duration;
					}
					else {
						this.data.segments[segmentId].best.duration.run = null;
					}
				}

				if (!segment.history) {
					segment.history = [];
					this.data.segments[segmentId].history = [];
				}

				if (!ignoreDuration) {
					this.data.segments[segmentId].history.push(segment.duration);
				}
			}
		}

		var allData = JSON.parse(localStorage.getItem('data'));

		for (i in allData) {
			if (allData[i].id == this.data.id) {
				allData[i] = this.data;
				break;
			}
		}

		localStorage.setItem('data', JSON.stringify(allData, this.replacer));
		this.saved = true;
	},
	saved: true,
	saveEdits: function() {
		var data = this.gatherEdits();
		this.storeEdits(data);
	},
	skipSplit: function() {
		// make sure we disregard all of the active split's time data...
		var activeSegmentId = this.activeSegmentId();
		this.ignoreSegmentSplit(activeSegmentId);
		this.ignoreSegmentDuration(activeSegmentId);

		// ...then advance the split...
		this.advanceActiveSegment();

		// ...and then ignore that split's duration data
		activeSegmentId = this.activeSegmentId();
		this.ignoreSegmentDuration(activeSegmentId);

		this.finalizeRunTable();
	},
	split: function() {
		this.advanceActiveSegment();
		this.finalizeRunTable();
	},
	splitSegment: function(segmentId) {
		this.data.segments[segmentId].active = false;
		this.data.segments[segmentId].split = this.timer.runningTime();
		this.data.segments[segmentId].duration = this.data.segments[segmentId].split - this.data.segments[segmentId].start;

	},
	standardDeviations: function() {
		for (var segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];

			var sum = 0;
			var variance = 0;

			for (var id in segment.history) {
				sum += segment.history[id];
			}

			var average = sum / segment.history.length;

			for (var id in segment.history) {
				variance += Math.pow(segment.history[id] - average, 2);
			}

			var stDev = Math.sqrt(variance / segment.history.length);
			console.log(segment.name + ': ' + this.timer.formatMilliseconds(Math.round(stDev)));
		}
	},
	start: function() {
		this.running = true;
		this.saved = false;
		this.timer.start(this.updateRunTable);
		this.advanceActiveSegment();
	},
	stop: function() {
		this.running = false;
		this.timer.stop();
		this.finalizeRunTable();
	},
	storeEdits: function(data) {
		var allData = JSON.parse(localStorage.getItem('data'));

		if (!allData) {
			allData = [];
		}

		if (!data.id) {
			data.id = allData.length + 1;
		}

		if (data.id > allData.length) {
			allData.push(data);
		}
		else {
			for (i in allData) {
				if (allData[i].id == data.id) {
					if (allData[i].segments.length != data.segments.length) {
						var proceed = confirm('Changing the number of total segments in this run will erase all of its prior split data. Is that okay?');

						if (!proceed) {
							break;
						}
						else {
							allData[i].segments = [];
						}
					}

					allData[i].game = data.game;
					allData[i].category = data.category;

					for (j in data.segments) {
						if (!allData[i].segments[j]) {
							allData[i].segments[j] = {};
						}

						allData[i].segments[j].name = data.segments[j].name;
					}

					break;
				}
			}
		}

		for (i in allData) {
			if (allData[i].id == data.id) {
				data = allData[i];
				break;
			}
		}

		this.data = data;
		localStorage.setItem('data', JSON.stringify(allData, this.replacer));

	},
	timer: {
		anchor: null,
		date: null,
		elapsed: function(since) {
			return this.time() - this.anchor;
		},
		elapsedSince: function(time) {
			return this.formatMilliseconds(this.time() - this.anchor - time, true);
		},
		formatMilliseconds: function(milliseconds, explicitSign) {
			var componentClasses = ['centiseconds', 'seconds', 'minutes', 'hours', 'days'];

			milliseconds = Math.round(milliseconds / 10) * 10;

			var sign = (milliseconds < 0) ? '-' : (explicitSign ? '+' : '');

			milliseconds = Math.abs(milliseconds);

			var hours = Math.floor(milliseconds / (1000 * 60 * 60));
			var minutes = Math.floor(milliseconds / (1000 * 60)) % 60;
			var seconds = Math.floor(milliseconds / 1000) % 60;
			var centiseconds = Math.floor((milliseconds % 1000) / 10);

			var formattedTime;

			if (centiseconds < 10) {
				centiseconds = '0' + centiseconds;
			}

			if (centiseconds == 100) {
				centiseconds = '00';
			}

			formattedTime = centiseconds;

			if (seconds > 0) {
				if ((minutes > 0 || hours > 0) && seconds < 10) {
					seconds = '0' + seconds;
				}

				formattedTime = seconds + '.' + formattedTime;
			}
			else if (seconds == 0) {
				if (minutes > 0 || hours > 0) {
					formattedTime = '00' + '.' + formattedTime;
				}
				else {
					formattedTime = '0' + '.' + formattedTime;
				}
			}

			if (minutes > 0) {
				if (hours > 0 && minutes < 10) {
					minutes = '0' + minutes;
				}

				formattedTime = minutes + ':' + formattedTime;
			}
			else if (minutes == 0) {
				if (hours > 0) {
					formattedTime = '00' + ':' + formattedTime;
				}
			}

			if (hours > 0) {
				formattedTime = hours + ':' + formattedTime;
			}

			var components = formattedTime.split(/:|\./).reverse();

			for (var i in components) {
				var digits = components[i].split('');

				for (var j in digits) {
					digits[j] = '<div class="digit">' + digits[j] + '</div>';
				}

				components[i] = digits.join('');

				if (i == 0) {
					components[i] = '.' + components[i];
				}
				else if (i != components.length - 1) {
					components[i] = ':' + components[i];
				}

				components[i] = '<div class="' + componentClasses[i] + '">' + components[i] + '</div>';
			}

			formattedTime = components.reverse().join('');

			return sign + formattedTime;
		},
		interval: null,
		runningTime: function() {
			return this.time() - this.anchor;
		},
		start: function(callback) {
			this.anchor = this.time();
			this.interval = setInterval(callback, 10);
		},
		stop: function() {
			clearInterval(this.interval);
		},
		time: function() {
			delete this.date;
			this.date = new Date();
			return this.date.getTime();
		},
		unformatMilliseconds: function(hours, minutes, seconds, centiseconds) {
			return (hours * 60 * 60 * 1000) + (minutes * 60 * 1000) + (seconds * 1000) + (centiseconds * 10 + 4);
		}
	},
	timeSaves: function() {
		var sum = 0;

		for (segmentId in this.data.segments) {
			var segment = this.data.segments[segmentId];
			var timeSave = segment.best.duration.run - segment.best.duration.individual;

			sum += timeSave;

			console.log(segment.name + ': ' + this.timer.formatMilliseconds(timeSave));
		}
		console.log('Total: ' + this.timer.formatMilliseconds(sum));
	},
	unsplit: function() {
		this.regressActiveSegment();
		this.finalizeRunTable();
	},
	unsplitSegment: function(segmentId) {
		this.data.segments[segmentId].active = false;
		this.data.segments[segmentId].split = this.timer.runningTime();
		this.data.segments[segmentId].duration = this.data.segments[segmentId].split - this.data.segments[segmentId].start;

	},
	updateRunTable: function() {
		$('div#run div.segment').removeClass('active');
		$('div#run div.slice').removeClass('active');

		var activeSegmentId = run.activeSegmentId();
		var $activeSegment = $('div#run div#segment' + activeSegmentId + '.segment').addClass('active');
		var $activeSlice = $('div#run div#slice' + activeSegmentId + '.slice').addClass('active');
		var $target = $('div#run div.timer div.target');
		var $timer = $('div#run div.timer div.clock');

		//$activeSegment.find('div.split').text(run.timer.elapsed());
		//$target.html('Target: ' + run.timer.formatMilliseconds(run.data.segments[activeSegmentId].best.duration.individual));
		$timer.html(run.timer.formatMilliseconds(run.timer.elapsed()));

		if (run.data.segments[activeSegmentId].best && run.data.segments[activeSegmentId].best.split) {
			var difference = run.timer.elapsedSince(run.data.segments[activeSegmentId].best.split);

			$activeSegment.find('div.difference').html(difference);

			if (difference[0] == '-') {
				$activeSegment.find('div.difference').removeClass('behind').addClass('ahead');
			}
			else {
				$activeSegment.find('div.difference').removeClass('ahead').addClass('behind');
			}
		}
	}
};

$(document).ready(function() {
	var allData = JSON.parse(localStorage.getItem('data'));

	if (allData) {
		run.load(1);
		run.generateRunTable();
	}
	else if (typeof data != 'undefined') {
		run.data = data[0];
		localStorage.setItem('data', JSON.stringify(data, run.replacer));
		run.generateRunTable();
	}
	else {
		run.editing = true;
		run.generateEditRunMarkup();
	}

	$('body').keydown(function(e) {
		//console.log(e);

		if (!run.editing) {
			switch (e.keyCode) {
				case 8: /* backspace is for going back to the last split */
					e.preventDefault();
					if (run.running) {
						run.unsplit();
					}
					break;

				case 27: /* escape is for turning off the help menu */
					$('body div#run').show();
					$('body div#help').hide();
					break;

				case 32: /* spacebar is for start/split */
					e.preventDefault();
					if (!run.running) {
						// don't start a new run until the previous one has been saved or reset
						if (!run.saved) {
							return;
						}

						run.reset();
						run.start();
					}
					else {
						run.split();
					}

					break;

				case 49: /* 1 is for load set of segments #1 */
				case 50: /* 2 is for load set of segments #2 */
				case 51: /* 3 is for load set of segments #3 */
				case 52: /* 4 is for load set of segments #4 */
				case 53: /* 5 is for load set of segments #5 */
				case 54: /* 6 is for load set of segments #6 */
				case 55: /* 7 is for load set of segments #7 */
				case 56: /* 8 is for load set of segments #8 */
				case 57: /* 9 is for load set of segments #9 */
					if (!run.running && !e.altKey && !e.ctrlKey && !e.shiftKey && !e.metaKey) {
						run.reset();
						run.load(e.keyCode - 48);
					}
					break;

				case 65: /* a is for add set of segments */
					if (!run.running && !e.altKey && !e.ctrlKey && !e.shiftKey && !e.metaKey) {
						run.generateEditRunMarkup();
						run.editing = true;
					}

					break;

				case 69: /* e is for edit set of segments */
					if (!run.running && !e.altKey && !e.ctrlKey && !e.shiftKey && !e.metaKey) {
						run.generateEditRunMarkup(run.data);
						run.editing = true;
					}

					break;

				case 76: /* l is for load */
					break;

				case 78: /* n is for load next set of segments */
					if (!run.running && !e.altKey && !e.ctrlKey && !e.shiftKey && !e.metaKey) {
						var allData = JSON.parse(localStorage.getItem('data'));

						if (run.data.id == allData.length) {
							var nextSegmentSetId = 1;
						}
						else {
							var nextSegmentSetId = run.data.id + 1;
						}

						run.reset();
						run.load(nextSegmentSetId);
					}
					break;

				case 79: /* o is for output segment data */
					console.log('segments: ' + JSON.stringify(run.data.segments));
					console.log('segments: ' + JSON.stringify(run.data.segments, run.replacer, '\t'));
					break;

				case 80: /* p is for load previous set of segments */
					if (!run.running && !e.altKey && !e.ctrlKey && !e.shiftKey && !e.metaKey) {
						var allData = JSON.parse(localStorage.getItem('data'));

						if (run.data.id == 1) {
							var previousSegmentSetId = allData.length;
						}
						else {
							var previousSegmentSetId = run.data.id - 1;
						}

						run.reset();
						run.load(previousSegmentSetId);
					}
					break;

				case 82: /* R is for reset */
					if (e.shiftKey && !e.altKey && !e.ctrlKey && !e.metaKey) {
						if (run.running) {
							run.stop();
						}
						else {
							run.reset();
						}
					}

					break;

				case 83: /* s is for skip; S is for save */
					 if (!e.altKey && !e.ctrlKey && !e.metaKey) {
						if (e.shiftKey) {
							if (!run.running && !run.saved) {
								run.save();
							}
						}
						else {
							if (run.running) {
								run.skipSplit();
							}
						}
					}

					break;

				case 191: /* ? is for help */
					if (!e.altKey && !e.ctrlKey && !e.metaKey) {
						if (e.shiftKey) {
							$('body div#run').toggle();
							$('body div#help').toggle();
						}
					}

					break;
			}
		}
		else {
			/* escape is for leaving edit mode */
			if (e.keyCode == 27) {
				run.editing = false;
				run.generateRunTable();
			}
		}
	});

	$('body').on('click', 'div#run div.actions button#save', function(e) {
		e.preventDefault();

		if (run.editing) {
			run.editing = false;
			run.saveEdits();
			run.generateRunTable();
		}
	});

	$('body').on('click', 'div#run div.actions a#cancel', function(e) {
		e.preventDefault();

		run.editing = false;
		run.generateRunTable();
	});
});
